<!DOCTYPE html>
<html>
<head>
  <title>Zerodha Arbitrage Dashboard</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body { background: #e6f2ff; font-family: sans-serif; text-align: center; }
    h1 { margin-bottom: 10px; }
    .tab { display: inline-block; padding: 10px 20px; background: #ccc; cursor: pointer; }
    .tab.active { background: #007BFF; color: white; font-weight: bold; }
    .tab-content { display: none; padding-top: 20px; }
    .tab-content.active { display: block; }
    table { width: 80%; margin: 0 auto; border-collapse: collapse; }
    th, td { border: 1px solid #aaa; padding: 10px; text-align: center; }
    th { background-color: #007BFF; color: white; }
    .positive { color: green; }
    .negative { color: red; }
    input { margin: 4px; padding: 6px; }
  </style>
</head>
<body>
  <h1>üìà Zerodha Arbitrage Opportunities</h1>

  <form method="POST" action="/register">
    <input name="apiKey" placeholder="API Key" required />
    <input name="apiSecret" placeholder="API Secret" required />
    <button type="submit">üîê Register & Login with Zerodha</button>
  </form>

  <div style="margin-top: 20px">
    <div class="tab active" onclick="switchTab('index')">Index Arbitrage</div>
    <div class="tab" onclick="switchTab('equity')">NSE-BSE Equity Arbitrage</div>
  </div>

  <!-- Index Arbitrage Table -->
  <div id="index" class="tab-content active">
    <table>
      <tr><th>Index</th><th>Spot Price</th><th>Futures Price</th><th>Arbitrage (Fut - Spot)</th></tr>
      <tr><td>NIFTY</td><td id="nifty-spot">--</td><td id="nifty-fut">--</td><td id="nifty-arb">--</td></tr>
      <tr><td>BANKNIFTY</td><td id="banknifty-spot">--</td><td id="banknifty-fut">--</td><td id="banknifty-arb">--</td></tr>
    </table>
  </div>

  <!-- Equity Arbitrage Table -->
  <div id="equity" class="tab-content">
    <table>
      <tr><th>Stock</th><th>NSE Price</th><th>BSE Price</th><th>Arbitrage (NSE - BSE)</th></tr>
      <tr><td>RELIANCE</td><td id="reliance-nse">--</td><td id="reliance-bse">--</td><td id="reliance-arb">--</td></tr>
      <tr><td>HDFCBANK</td><td id="hdfcbank-nse">--</td><td id="hdfcbank-bse">--</td><td id="hdfcbank-arb">--</td></tr>
      <tr><td>INFY</td><td id="infy-nse">--</td><td id="infy-bse">--</td><td id="infy-arb">--</td></tr>
    </table>
  </div>

  <script>
    const apiKey = sessionStorage.getItem('ZERODHA_API_KEY');
    const accessToken = localStorage.getItem('ZERODHA_ACCESS_TOKEN');

    if (apiKey && accessToken) {
      const socket = io();
      socket.emit("start-stream", { apiKey, accessToken });

      socket.on("arbitrage", data => {
        // Index Prices
        document.getElementById("nifty-spot").textContent = data.nifty.spot;
        document.getElementById("nifty-fut").textContent = data.nifty.future;
        document.getElementById("nifty-arb").innerHTML = formatDiff(data.nifty.future - data.nifty.spot);

        document.getElementById("banknifty-spot").textContent = data.banknifty.spot;
        document.getElementById("banknifty-fut").textContent = data.banknifty.future;
        document.getElementById("banknifty-arb").innerHTML = formatDiff(data.banknifty.future - data.banknifty.spot);

        // Equity Arbitrage
        ["reliance", "hdfcbank", "infy"].forEach(stock => {
          const nse = data[stock].nse;
          const bse = data[stock].bse;
          document.getElementById(`${stock}-nse`).textContent = nse;
          document.getElementById(`${stock}-bse`).textContent = bse;
          document.getElementById(`${stock}-arb`).innerHTML = formatDiff(nse - bse);
        });
      });
    }

    function formatDiff(diff) {
      const color = diff >= 0 ? 'positive' : 'negative';
      return `<span class="${color}">${diff.toFixed(2)}</span>`;
    }

    function switchTab(tab) {
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
      document.getElementById(tab).classList.add("active");
      document.querySelector(`.tab[onclick*='${tab}']`).classList.add("active");
    }
  </script>
</body>
</html>
