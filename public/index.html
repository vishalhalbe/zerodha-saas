<!DOCTYPE html>
<html>
<head>
  <title>Zerodha Arbitrage Dashboard</title>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body {
      background-color: #e6f2ff;
      font-family: sans-serif;
      text-align: center;
    }
    h1 {
      background: #007bff;
      color: white;
      padding: 1rem;
      margin: 0;
    }
    .tabs button {
      margin: 1rem;
      padding: 0.5rem 1rem;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .tabs .active {
      background-color: #007bff;
      color: white;
    }
    table {
      width: 80%;
      margin: 0 auto;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.75rem;
      text-align: center;
    }
    th {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>

  <h1>üìà Zerodha Arbitrage Dashboard</h1>

  <form method="POST" action="/register">
    <input name="apiKey" placeholder="API Key" required />
    <input name="apiSecret" placeholder="API Secret" required />
    <button type="submit">üîê Register & Login with Zerodha</button>
  </form>

  <div class="tabs">
    <button id="spotFutureBtn" class="active">Spot vs Future</button>
    <button id="nseBseBtn">NSE vs BSE</button>
  </div>

  <!-- Spot vs Future Table -->
  <div id="spotFutureTab">
    <table>
      <thead>
        <tr>
          <th>Index</th>
          <th>Spot Price</th>
          <th>Futures Price</th>
          <th>Arbitrage (Fut - Spot)</th>
        </tr>
      </thead>
      <tbody id="indexTableBody">
        <tr><td>NIFTY</td><td id="niftySpot">--</td><td id="niftyFut">--</td><td id="niftyDiff">--</td></tr>
        <tr><td>BANKNIFTY</td><td id="bankniftySpot">--</td><td id="bankniftyFut">--</td><td id="bankniftyDiff">--</td></tr>
      </tbody>
    </table>
  </div>

  <!-- NSE vs BSE Table -->
  <div id="nseBseTab" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>Stock</th>
          <th>NSE</th>
          <th>BSE</th>
          <th>Difference</th>
        </tr>
      </thead>
      <tbody id="nsebseTableBody">
        <tr><td>Reliance</td><td id="relianceNSE">--</td><td id="relianceBSE">--</td><td id="relianceDiff">--</td></tr>
        <tr><td>HDFC Bank</td><td id="hdfcNSE">--</td><td id="hdfcBSE">--</td><td id="hdfcDiff">--</td></tr>
        <tr><td>INFY</td><td id="infyNSE">--</td><td id="infyBSE">--</td><td id="infyDiff">--</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // Toggle between Spot-Future and NSE-BSE tabs
    const spotBtn = document.getElementById('spotFutureBtn');
    const nseBseBtn = document.getElementById('nseBseBtn');
    const spotTab = document.getElementById('spotFutureTab');
    const nseTab = document.getElementById('nseBseTab');

    spotBtn.addEventListener('click', () => {
      spotBtn.classList.add('active');
      nseBseBtn.classList.remove('active');
      spotTab.style.display = '';
      nseTab.style.display = 'none';
    });

    nseBseBtn.addEventListener('click', () => {
      nseBseBtn.classList.add('active');
      spotBtn.classList.remove('active');
      nseTab.style.display = '';
      spotTab.style.display = 'none';
    });

    // WebSocket connection
    const apiKey = sessionStorage.getItem('ZERODHA_API_KEY');
    const accessToken = localStorage.getItem('ZERODHA_ACCESS_TOKEN');
    if (apiKey && accessToken) {
      const socket = io();
      socket.emit("start-stream", { apiKey, accessToken });

      // Spot/Future ticks
      socket.on("tick", (ticks) => {
        ticks.forEach(tick => {
          const lp = tick.last_price;
          if (tick.instrument_token === 256265) document.getElementById("niftySpot").textContent = lp;
          if (tick.instrument_token === 260105) document.getElementById("bankniftySpot").textContent = lp;
          if (tick.instrument_token === window.niftyFutToken) {
            document.getElementById("niftyFut").textContent = lp;
            const spot = parseFloat(document.getElementById("niftySpot").textContent);
            document.getElementById("niftyDiff").textContent = (lp - spot).toFixed(2);
          }
          if (tick.instrument_token === window.bankniftyFutToken) {
            document.getElementById("bankniftyFut").textContent = lp;
            const spot = parseFloat(document.getElementById("bankniftySpot").textContent);
            document.getElementById("bankniftyDiff").textContent = (lp - spot).toFixed(2);
          }
        });
      });

      // NSE vs BSE LTP
      socket.on("bse-nse-arbitrage", (data) => {
        const update = (id, val) => document.getElementById(id).textContent = val.toFixed(2);
        update('relianceNSE', data.reliance.nse);
        update('relianceBSE', data.reliance.bse);
        update('relianceDiff', data.reliance.nse - data.reliance.bse);
        update('hdfcNSE', data.hdfc.nse);
        update('hdfcBSE', data.hdfc.bse);
        update('hdfcDiff', data.hdfc.nse - data.hdfc.bse);
        update('infyNSE', data.infy.nse);
        update('infyBSE', data.infy.bse);
        update('infyDiff', data.infy.nse - data.infy.bse);
      });
    }
  </script>
</body>
</html>
